# BIM Classification System Documentation

## Overview

The BIM (Building Information Modeling) Classification System is a microservices-based architecture designed to automate the processing and classification of BIM model elements using AI and machine learning. The system handles BIM file uploads, generates embeddings using OpenAI, clusters similar elements, and provides classification capabilities through trained models.

## System Architecture

The system follows a microservices architecture with the following components:

### C4 Level 2 Diagram

The following diagram illustrates the system architecture and component interactions:

<!-- puml: ./diagrams/c4-diagram.puml -->
```plantuml
@startuml
!include ./diagrams/c4-diagram.puml
@enduml
```

Источник: diagrams/c4-diagram.puml

Акторы в UML представлены как “Gmini (User)” и “Gmini (Admin)”, что соответствует текущим диаграммам проекта.

- **web_api**: FastAPI gateway that orchestrates all API requests and coordinates with other services.
- **bim_upload**: Service dedicated to processing BIM files, generating embeddings, and clustering elements.
- **bim_classification**: Service that handles classification processes using AI models.
- **llm_services**: Service for training and managing Large Language Models (LLMs).
- **PostgreSQL**: Relational database storing metadata, status information, and process tracking.
- **ClickHouse**: Columnar database optimized for storing BIM element embeddings and large-scale data.
- **S3 Storage**: Object storage for BIM files (nodes.json, edges.json, properties.json) and classification results (CSV uploaded as result/{classification_id}.csv).
- **OpenAI API**: External service used for generating text embeddings of BIM elements.

### Component Details

#### Web API (web_api)

- **Purpose**: Main entry point for all client interactions. Validates requests, manages API endpoints, and orchestrates other services.
- **Key Functions**:
  - Receives HTTP requests from clients (users or administrators).
  - Validates input parameters and request data.
  - Stores metadata in PostgreSQL (BIM info, classification records, LLM training records).
  - Triggers appropriate services (bim_upload, bim_classification, llm_services) for asynchronous processing.
  - Returns responses to clients with status codes and relevant data.

#### BIM Upload Service (bim_upload)

- **Purpose**: Processes uploaded BIM files, generates embeddings, and clusters elements.
- **Key Functions**:
  - Downloads BIM files from S3 storage (nodes.json, edges.json, properties.json).
  - Parses JSON files to extract element information and relationships.
  - Creates textual descriptions for each BIM element by combining properties and parent-child relationships.
  - Generates embeddings using OpenAI's API for each element description.
  - Stores embeddings in ClickHouse with temporary cluster IDs.
  - Performs clustering using DBSCAN algorithm with cosine similarity to group similar elements.
  - Updates final cluster IDs in ClickHouse and progress status in PostgreSQL.

#### BIM Classification Service (bim_classification)

- **Purpose**: Handles the classification of BIM elements using trained AI models.
- **Key Functions**:
  - Receives classification requests from web_api.
  - Accesses clustered embeddings from ClickHouse for the specified BIM model.
  - Performs classification using AI models (details depend on the implementation in use_cases).
  - Updates classification status and results in PostgreSQL.
  - Supports stopping ongoing classification processes.

#### LLM Services (llm_services)

- **Purpose**: Manages the training of Large Language Models for classification tasks.
- **Key Functions**:
  - Receives training requests from web_api.
  - Accesses training data from S3 storage.
  - Trains new LLM models based on provided parameters and data.
  - Responds to web_api; web_api is responsible for recording new LLM entries in PostgreSQL upon successful response.
  - Provides list of available LLMs via web_api.

#### Data Storage

- **PostgreSQL**: Stores all metadata and status information:
  - BIM model metadata (ID, name, description, upload status, progress percentage).
  - Classification records (ID, BIM ID, status, parameters, results).
  - LLM training records (ID, base model, training data path, status).
- **ClickHouse**: Stores BIM element data:
  - Element embeddings (vector representations generated by OpenAI).
  - Cluster IDs for grouped elements.
  - Optimized for large-scale data and efficient querying.

#### External Services

- **S3 Storage**: Holds BIM files in JSON format:
  - nodes.json: Contains object metadata (objectId, name, etc.).
  - edges.json: Contains parent-child relationships between objects.
  - properties.json: Contains detailed properties for each object.
- **OpenAI API**: Used for generating text embeddings:
  - Element descriptions are sent to OpenAI's embedding model.
  - Returns vector embeddings used for clustering and classification.

## Key Processes

### BIM Upload Process

1. **Client Request**: User sends POST request to `/bim_models` with BIM info (name, S3 path).
2. **Validation**: web_api validates the request and checks if any upload is in progress.
3. **Metadata Storage**: web_api generates a BIM ID and stores initial metadata in PostgreSQL with status "IN_PROGRESS".
4. **Service Trigger**: web_api triggers bim_upload service asynchronously with the BIM ID.
5. **File Download**: bim_upload downloads BIM files from S3 based on the provided paths.
6. **Processing**: bim_upload parses JSON files, creates element descriptions, and generates embeddings via OpenAI API.
7. **Storage**: Embeddings are stored in ClickHouse with temporary cluster IDs.
8. **Clustering**: Elements are clustered using DBSCAN algorithm, and final cluster IDs are updated in ClickHouse.
9. **Status Update**: Progress is updated in PostgreSQL (0-100%), culminating in "COMPLETED" status.

**Sequence Diagram for BIM Upload Process:**

```puml
@startuml
!include_relative diagrams/sequence-bim-upload.puml
@enduml
```

### Classification Process

Note: In code, classification records are created with status IN_PROGRESS (not PENDING).

1. **Client Request**: User sends POST request to `/bim_models/{bim_id}/classification` with classification parameters.
2. **Validation**: web_api validates the request and BIM ID.
3. **Record Creation**: web_api creates a classification record in PostgreSQL with status "IN_PROGRESS".
4. **Service Trigger**: web_api triggers bim_classification service asynchronously with the classification ID.
5. **Classification**: bim_classification accesses embeddings from ClickHouse, performs classification using AI models, updates progress while status remains "IN_PROGRESS", and finally reaches "COMPLETED".
6. **Result Storage**: Classification results are stored in PostgreSQL.

### LLM Training Process

Note: In code, a new LLM entry is inserted into PostgreSQL only after llm_services returns 200 OK.

1. **Client Request**: User sends POST request to `/llms` with training data parameters.
2. **Validation**: web_api validates the request.
3. **Record Creation**: After llm_services responds with 200 OK, web_api inserts a new LLM entry into PostgreSQL.
4. **Service Trigger**: web_api triggers llm_services asynchronously with training parameters.
5. **Data Access**: llm_services accesses training data from S3.
6. **Training**: llm_services trains the LLM model and updates status to "COMPLETED".
7. **Model Storage**: Trained model is stored (implementation specific).

## API Endpoints

### BIM Management Endpoints

- `POST /bim_models`: Upload a BIM model (initiates async processing).
- `GET /bim_models/{bim_id}/status`: Get upload status of a specific BIM model.
- `GET /bim_models`: List all uploaded BIM models (with pagination).
- `DELETE /bim_models/{bim_id}`: Delete a BIM model and its data.

### Classification Endpoints

- `POST /bim_models/{bim_id}/classification`: Start classification for a BIM model.
- `GET /classification_status/{classification_id}`: Get status of a classification process.
- `POST /stop_classification/{classification_id}`: Stop a running classification process.

### LLM Management Endpoints

- `GET /llms`: List available LLMs (with pagination).
- `POST /llms`: Train a new LLM model (initiates async training).

## Error Handling

The system implements comprehensive error handling:

- **Input Validation**: All endpoints validate input parameters and return HTTP 400 for invalid requests.
- **Resource Checks**: Checks for existing processes (e.g., upload already in progress) return HTTP 400.
- **NotFound Handling**: Missing resources (BIM ID, classification ID) return HTTP 404.
- **Internal Errors**: Unhandled exceptions return HTTP 500 with generic messages to avoid exposing internal details.
- **Async Processing**: Background tasks handle processing, and status is tracked in PostgreSQL for monitoring.

## Data Flow

1. **Client to web_api**: HTTP requests with JSON payloads.
2. **web_api to PostgreSQL**: SQL queries for metadata storage and retrieval.
3. **web_api to Services**: HTTP requests to trigger processing (bim_upload, bim_classification, llm_services).
4. **Services to S3**: AWS SDK calls to download BIM files or training data.
5. **Services to OpenAI API**: HTTP requests to generate embeddings.
6. **Services to ClickHouse**: SQL queries for storing and retrieving embeddings.
7. **Services to PostgreSQL**: SQL queries for updating status and results.

## Release 1.0 constraints

- Single-user API mode; open API without authentication
- Only one BIM upload can be processed at a time
- Only one classification process can run at a time
- Fault tolerance is provided by Docker services
- Upgrades are performed similarly to initial startup (system downtime equals time between start of rollout and readiness of all services)

Примечание: некоторые дополнительные эндпоинты (например, получение списка всех результатов классификаций) отсутствуют в текущем коде и могут быть реализованы в следующих релизах.

## Diagrams

For visual representations of the system architecture and workflows, refer to the following diagrams (rendered PNG + source .puml in docs/diagrams):

- C4 Level 2 Diagram: diagrams/c4-diagram.puml - Shows all system components and their interactions.
- Sequence Diagrams:
  - diagrams/sequence-bim-upload.puml - POST /bim_models (BIM upload process).
  - diagrams/sequence-bim-status.puml - GET /bim_models/{bim_id}/status (status check).
  - diagrams/sequence-bim-list.puml - GET /bim_models (list BIM models).
  - diagrams/sequence-bim-delete.puml - DELETE /bim_models/{bim_id} (delete BIM model).
  - diagrams/sequence-classification-start.puml - POST /bim_models/{bim_id}/classification (start classification).
  - diagrams/sequence-classification-status.puml - GET /classification_status/{classification_id} (classification status).
  - diagrams/sequence-classification-stop.puml - POST /stop_classification/{classification_id} (stop classification).
  - diagrams/sequence-llm-list.puml - GET /llms (list LLMs).
  - diagrams/sequence-llm-train.puml - POST /llms (train LLM).

## Conclusion

This BIM Classification System provides a scalable and efficient solution for automating BIM model processing and classification. The microservices architecture allows for independent scaling of components, while the use of PostgreSQL and ClickHouse ensures reliable metadata management and high-performance data handling. Integration with S3 and OpenAI API enables flexible storage and advanced AI capabilities.

For deployment and configuration details, refer to the README.md file in the repository.
